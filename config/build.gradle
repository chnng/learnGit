apply from: rootProject.ext.gradle_path_module_app
//apply plugin: 'auto-patch-plugin'
//apply plugin: 'robust'

android {
//    dexOptions {
//        javaMaxHeapSize '4g'
//    }
//    publishNonDefault true
    flavorDimensions 'app', 'url'
    productFlavors {
        // 生产
        Formal {
            dimension 'url'
            buildConfigField 'boolean', 'AUTH', 'true'
        }
        // 预生产
        Prepare {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.prepare + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.prepare + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.prepare + rootProject.ext.port.rcLocal
            buildConfigField 'int', 'BED_CARD_TYPE', '0'
            applicationIdSuffix '.pre'
        }
        // 演示
        Demo {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.demo + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.demo + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.demo + rootProject.ext.port.rcLocal
            applicationIdSuffix '.demo'
        }
        // 内网
        Local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.prepare + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.local + rootProject.ext.port.rcLocal
            applicationIdSuffix '.local'
        }
//        常州武进人民location {
//            dimension 'url'
//            applicationIdSuffix '.wjrm'
//            resValue 'string', 'amap_location', rootProject.ext.location.常州市武进人民医院
//        }
//        常州武进人民南院location {
//            dimension 'url'
//            applicationIdSuffix '.wjrmny'
//            resValue 'string', 'amap_location', rootProject.ext.location.常州市武进人民医院南院
//        }
//        山东聊城人民location {
//            dimension 'url'
//            applicationIdSuffix '.lcrm'
//            resValue 'string', 'amap_location', rootProject.ext.location.山东聊城市人民医院
//        }
//        苏大一医院广慈分院location {
//            dimension 'url'
//            applicationIdSuffix '.szgc'
//            resValue 'string', 'amap_location', rootProject.ext.location.苏州大学附属第一医院广慈分院
//        }
//        威海妇幼保健院location {
//            dimension 'url'
//            applicationIdSuffix '.whfy'
//            resValue 'string', 'amap_location', rootProject.ext.location.威海妇幼保健院
//        }
//        青岛妇女儿童location {
//            dimension 'url'
//            applicationIdSuffix '.qdfe'
//            resValue 'string', 'amap_location', rootProject.ext.location.青岛市妇女儿童医院
//        }
//        广西中医药大学仙葫校区location {
//            dimension 'url'
//            applicationIdSuffix '.gxzyy'
//            resValue 'string', 'amap_location', rootProject.ext.location.广西中医药大学仙葫校区
//        }
//        潍坊中医院location {
//            dimension 'url'
//            applicationIdSuffix '.wfz'
//            resValue 'string', 'amap_location', rootProject.ext.location.潍坊中医院
//        }
        淄博中西医formal {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.淄博中西医formal + rootProject.ext.port.erZiboApi
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.淄博中西医formal + rootProject.ext.port.erZibo
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.淄博中西医formal + rootProject.ext.port.rcZibo
        }
        泰兴人民local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.泰兴人民local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.泰兴人民local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.泰兴人民local + rootProject.ext.port.rcLocal
        }
        南阳骨科local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.南阳骨科local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.南阳骨科local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.南阳骨科local + rootProject.ext.port.rcLocal
        }
        北大深圳local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.北大深圳local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.北大深圳local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.北大深圳local + rootProject.ext.port.rcLocal
        }
        广中医仙葫local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.rcLocal
        }
        广中医东葛local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.mnApi
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.mnWeb
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.广西中医药local + rootProject.ext.port.rcLocal
        }
        上海中西医local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.上海中西医local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.上海中西医local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.上海中西医local + rootProject.ext.port.rcLocal
        }
        无锡三院local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.无锡三院local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.无锡三院local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.无锡三院local + rootProject.ext.port.rcLocal
        }
        苏大广慈local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.苏大广慈local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.苏大广慈local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.苏大广慈local + rootProject.ext.port.rcLocal
        }
        深圳罗湖妇幼local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.深圳罗湖妇幼local + rootProject.ext.port.base
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.深圳罗湖妇幼local + rootProject.ext.port.mn
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.深圳罗湖妇幼local + rootProject.ext.port.rcLocal
        }
        湖南省直中医院local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.湖南省直中医院local + rootProject.ext.port.mnApi
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.湖南省直中医院local + rootProject.ext.port.mnWeb
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.湖南省直中医院local + rootProject.ext.port.rcLocal
        }
        嘉兴二院formal {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.嘉兴二院formal + rootProject.ext.port.mnApi
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.嘉兴二院formal + rootProject.ext.port.mnWeb
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.嘉兴二院formal + rootProject.ext.port.rcLocal
            buildConfigField 'boolean', 'AUTH', 'false'
        }
        嘉兴二院local {
            dimension 'url'
            buildConfigField 'String', 'BASE_URL', rootProject.ext.domain.嘉兴二院local + rootProject.ext.port.mnApi
            buildConfigField 'String', 'WEB_URL', rootProject.ext.domain.嘉兴二院local + rootProject.ext.port.mnWeb
            buildConfigField 'String', 'RC_URL', rootProject.ext.domain.嘉兴二院local + rootProject.ext.port.rcLocal
        }
        thNati {
            dimension 'app'
            applicationId rootProject.ext.th.applicationId
            versionCode rootProject.ext.th.versionCode
            versionName rootProject.ext.th.versionName
            buildConfigField 'String', 'APP_CODE', rootProject.ext.th.appCode

            resValue 'string', 'bugly_app_id', rootProject.ext.th.buglyAppId
            resValue 'string', 'getui_app_id', rootProject.ext.call.getuiAppId
            resValue 'string', 'getui_app_key', rootProject.ext.call.getuiAppKey
            resValue 'string', 'getui_app_secret', rootProject.ext.call.getuiAppSecret
            resValue 'string', 'getui_master_secret', rootProject.ext.call.getuiMasterSecret
        }
        mnH5 {
            dimension 'app'
            applicationId rootProject.ext.mn.applicationId
            versionCode rootProject.ext.mn.versionCode
            versionName rootProject.ext.mn.versionName
            ndk {
                abiFilters 'armeabi-v7a', 'arm64-v8a'
            }
            buildConfigField 'String', 'APP_CODE', rootProject.ext.mn.appCode
            buildConfigField 'boolean', 'AUTH', 'false'

            resValue 'string', 'bugly_app_id', rootProject.ext.th.buglyAppId
            resValue 'string', 'getui_app_id', rootProject.ext.call.getuiAppId
            resValue 'string', 'getui_app_key', rootProject.ext.call.getuiAppKey
            resValue 'string', 'getui_app_secret', rootProject.ext.call.getuiAppSecret
            resValue 'string', 'getui_master_secret', rootProject.ext.call.getuiMasterSecret
        }
        mnNati {
            dimension 'app'
            applicationId rootProject.ext.mn.applicationId
            versionCode rootProject.ext.mn.versionCode
            versionName rootProject.ext.mn.versionName
            applicationIdSuffix '.nati'
            minSdkVersion 16
            ndk {
                abiFilters 'armeabi-v7a', 'arm64-v8a'
            }
            buildConfigField 'String', 'APP_CODE', rootProject.ext.mn.appCode
            buildConfigField 'boolean', 'AUTH', 'false'

            resValue 'string', 'bugly_app_id', rootProject.ext.mn.buglyAppId
            resValue 'string', 'getui_app_id', rootProject.ext.call.getuiAppId
            resValue 'string', 'getui_app_key', rootProject.ext.call.getuiAppKey
            resValue 'string', 'getui_app_secret', rootProject.ext.call.getuiAppSecret
            resValue 'string', 'getui_master_secret', rootProject.ext.call.getuiMasterSecret
        }
        expertRemoteH5 {
            dimension 'app'
            applicationId rootProject.ext.er.applicationId
            versionCode rootProject.ext.er.versionCode
            versionName rootProject.ext.er.versionName
            buildConfigField 'String', 'APP_CODE', rootProject.ext.er.appCode
        }
        expertRemoteNative {
            dimension 'app'
            applicationId rootProject.ext.er.applicationId
            versionCode rootProject.ext.er.versionCode
            versionName rootProject.ext.er.versionName
            applicationIdSuffix '.nati'
            buildConfigField 'String', 'APP_CODE', rootProject.ext.er.appCode
        }
        ydcf {
            dimension 'app'
            applicationId rootProject.ext.ydcf.applicationId
            versionCode rootProject.ext.ydcf.versionCode
            versionName rootProject.ext.ydcf.versionName
            buildConfigField 'String', 'APP_CODE', rootProject.ext.ydcf.appCode
        }
        ydhl {
            dimension 'app'
            applicationId rootProject.ext.ydhl.applicationId
            versionCode rootProject.ext.ydhl.versionCode
            versionName rootProject.ext.ydhl.versionName
            buildConfigField 'String', 'APP_CODE', rootProject.ext.ydhl.appCode
        }
    }

    android.variantFilter { variant ->
        def names = variant.flavors*.name
        if (!names.contains('Formal') && !names.contains('Prepare')) {
            variant.setIgnore(true)
        }
        if (names.contains('thNati')) {
            if (/*names.contains('常州武进人民location')
                    || names.contains('常州武进人民南院location')
                    || names.contains('山东聊城人民location')
                    || names.contains('苏大一医院广慈分院location')
                    || names.contains('威海妇幼保健院location')
                    || names.contains('青岛妇女儿童location')
                    || names.contains('广西中医药大学仙葫校区location')
                    || names.contains('潍坊中医院location')
                    || */names.contains('嘉兴二院formal')
            ) {
                variant.setIgnore(false)
            }
        } else if (names.contains('mnH5')) {
            if (names.contains('Demo')
                    || names.contains('Local')
                    || names.contains('北大深圳local')
                    || names.contains('广中医仙葫local')
                    || names.contains('上海中西医local')
                    || names.contains('无锡三院local')
                    || names.contains('苏大广慈local')
                    || names.contains('深圳罗湖妇幼local')
                    || names.contains('泰兴人民local')
                    || names.contains('南阳骨科local')
            ) {
                variant.setIgnore(false)
            }
        } else if (names.contains('mnNati')) {
            if (names.contains('Demo')
                    || names.contains('湖南省直中医院local')
                    || names.contains('广中医仙葫local')
                    || names.contains('嘉兴二院local')
            ) {
                variant.setIgnore(false)
            }
        } else if (names.contains('mH5')) {
            if (names.contains('Demo')
                    || names.contains('Local')
            ) {
                variant.setIgnore(false)
            }
        } else if (names.contains('expertRemoteH5')
                || names.contains('expertRemoteNative')
        ) {
            if (names.contains('淄博中西医formal')) {
                variant.setIgnore(false)
            }
        }
        // To check for a certain build type, use variant.buildType.name == "<buildType>"
        if (variant.buildType.name == 'release' && !variant.ignore) {
//            variant.getFlavors().each() { flavor ->
//            }
            variant.setIgnore(gradle.ext.RELEASE_IGNORE)
        }
    }

    // https://blog.csdn.net/aa112901a/article/details/78911775
    // https://blog.csdn.net/angcyo/article/details/78357512
    // https://github.com/JakeWharton/butterknife/issues/1431
    android.applicationVariants.all { variant ->
        if (variant.buildType.name == "debug") { // 防止AS无法安装debug包(apk)
//            variant.getPackageApplicationProvider().get().outputDirectory = new File(project.rootDir.absolutePath + '/apk')
            variant.getPackageApplication().outputDirectory = new File(project.rootDir.absolutePath + '/apk')
        }
        def baseName = variant.baseName, flavorName = 'app'
        def index = baseName.indexOf('-')
        def flavor = baseName.substring(index, baseName.indexOf('-', index + 1))
        def baseUrl, webUrl
        variant.outputs.each { output ->
            if (baseName.contains('Demo')) {
                output.versionNameOverride = variant.versionName + 'd'
            } else if (baseName.contains('Prepare')) {
                output.versionNameOverride = variant.versionName + 'p'
            } else if (baseName.contains('Local')) {
                output.versionNameOverride = variant.versionName + 'l'
            }
            if (baseName.contains('thNati')) {
                flavorName = rootProject.ext.th.appName
//                webUrl = rootProject.ext.domain.formal + rootProject.ext.port.th
                if (baseName.contains('Demo')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.demo + rootProject.ext.port.th
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.prepare + rootProject.ext.port.th
                }/* else if (baseName.contains('常州武进人民location')) {
                    flavorName = '天护武进'
                } else if (baseName.contains('常州武进人民南院location')) {
                    flavorName = '天护武进南'
                } else if (baseName.contains('山东聊城人民location')) {
                    flavorName = '天护聊城'
                } else if (baseName.contains('苏大一医院广慈分院location')) {
                    flavorName = '天护广慈'
                } else if (baseName.contains('威海妇幼保健院location')) {
                    flavorName = '天护威海'
                } else if (baseName.contains('青岛妇女儿童location')) {
                    flavorName = '天护青岛'
                } else if (baseName.contains('广西中医药大学仙葫校区location')) {
                    flavorName = '天护广中仙葫'
                } else if (baseName.contains('潍坊中医院location')) {
                    flavorName = '天护潍坊'
                }*/
                variant.mergedFlavor.manifestPlaceholders = [AMAP_KEY: rootProject.ext.th.amapKey]
            } else if (baseName.contains('mnH5')) {
                flavorName = rootProject.ext.mn.appName
                if (baseName.contains('Demo')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.demoWeb + rootProject.ext.port.mn
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                } else if (baseName.contains('Local')) {
                    flavorName += flavor
                }
                variant.mergedFlavor.manifestPlaceholders = [AMAP_KEY: rootProject.ext.mn.amapKey]
            } else if (baseName.contains('mnNati')) {
                flavorName = rootProject.ext.mn.appNameNative
                if (baseName.contains('Formal')) {
                    baseUrl = rootProject.ext.domain.formal + rootProject.ext.port.mnApi
                    webUrl = rootProject.ext.domain.formal + rootProject.ext.port.mnWeb
                } else if (baseName.contains('Demo')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.demo + rootProject.ext.port.mnApi
                    webUrl = rootProject.ext.domain.demoWeb + rootProject.ext.port.mnWeb
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.prepare + rootProject.ext.port.mnApi
                    webUrl = rootProject.ext.domain.prepare + rootProject.ext.port.mnWeb
                } else if (baseName.contains('Local')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.local + rootProject.ext.port.mnApi
                    webUrl = rootProject.ext.domain.local + rootProject.ext.port.mnWeb
                }
                variant.mergedFlavor.manifestPlaceholders = [AMAP_KEY: rootProject.ext.mn.amapKey]
            } else if (baseName.contains('expertRemoteH5')) {
                flavorName = rootProject.ext.er.appName
                webUrl = rootProject.ext.domain.formal + rootProject.ext.port.erFormal
                if (baseName.contains('Demo')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.demo + rootProject.ext.port.erLocal
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.prepare + rootProject.ext.port.erLocal
                } else if (baseName.contains('Local')) {
                    flavorName += flavor
                    webUrl = rootProject.ext.domain.local + rootProject.ext.port.erLocal
                }
            } else if (baseName.contains('expertRemoteNative')) {
                flavorName = rootProject.ext.er.appNameNative + flavor
            } else if (baseName.contains('ydcf')) {
                flavorName = rootProject.ext.ydcf.appName
                baseUrl = rootProject.ext.domain.formal + rootProject.ext.port.ydcfApi
                if (baseName.contains('Demo')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.demo + rootProject.ext.port.ydcfApi
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.prepare + rootProject.ext.port.ydcfApi
                } else if (baseName.contains('Local')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.local + rootProject.ext.port.ydcfApi
                }
            } else if (baseName.contains('ydhl')) {
                flavorName = rootProject.ext.ydhl.appName
                baseUrl = rootProject.ext.domain.formal + rootProject.ext.port.ydhlApi
                if (baseName.contains('Demo')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.demo + rootProject.ext.port.ydhlApi
                } else if (baseName.contains('Prepare')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.prepare + rootProject.ext.port.ydhlApi
                } else if (baseName.contains('Local')) {
                    flavorName += flavor
                    baseUrl = rootProject.ext.domain.local + rootProject.ext.port.ydhlApi
                }
            }
            variant.resValue 'string', 'app_name', flavorName
            if (baseUrl != null) {
                variant.buildConfigField 'String', 'BASE_URL', baseUrl
            }
            if (webUrl != null) {
                variant.buildConfigField 'String', 'WEB_URL', webUrl
            }
            output.outputFileName = "${variant.flavorName}_v${variant.versionName}_${rootProject.releaseTime()}.apk"
            println '====>> variant:' + variant.baseName \
                                      + ' flavor:' + variant.flavorName \
                                      + ' to ' + flavorName \
                                      + ' version:' + variant.versionName \
                                      + ' output:' + output.outputFileName \
                                      + ' appid:' + variant.mergedFlavor.applicationId \
        }
    }
}

dependencies {
    implementation project(':library:base')
    def flag = gradle.ext.COMPILE_FLAG
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_TH_NATIVE) != 0) {
        thNatiImplementation project(':module:th:native')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_MN_H5) != 0) {
        mnH5Implementation project(':module:mn:h5')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_MN_NATIVE) != 0) {
        mnNatiImplementation project(':module:mn:native')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_ER_H5) != 0) {
        expertRemoteH5Implementation project(':module:er:h5')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_ER_NATIVE) != 0) {
        expertRemoteNativeImplementation project(':module:er:native')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_YDCF) != 0) {
        ydcfImplementation project(':module:ydcf')
    }
    if (flag == gradle.ext.MODULE_ALL || (flag & gradle.ext.MODULE_YDHL) != 0) {
        ydhlImplementation project(':module:ydhl')
    }
}
